# 功能文档

## 已实现功能清单

### 1. 基础功能

#### 1.1 股票数据查询
- **功能描述**: 支持输入股票代码查询历史数据
- **实现状态**: ✅ 已完成
- **实现文件**: `gui.py`, `data_fetcher.py`
- **详细说明**:
  - 支持自动识别股票代码格式（沪市 sh.、深市 sz.、北交所 bj.）
  - 支持日期范围选择（开始日期、结束日期）
  - 从 Baostock 获取历史 K 线数据
  - 数据字段包括：开盘价、最高价、最低价、收盘价、成交量、成交额、换手率、PE、PB 等

#### 1.2 PE 百分位计算
- **功能描述**: 计算市盈率在指定日期范围内的百分位
- **实现状态**: ✅ 已完成
- **实现文件**: `valuation_calculator.py`
- **详细说明**:
  - 使用滚动市盈率（peTTM）数据
  - 百分位计算公式：`(范围内比当前值小的数量) / (范围内总数 - 1) * 100`
  - 支持动态日期范围计算

#### 1.3 PB 百分位计算
- **功能描述**: 计算市净率在指定日期范围内的百分位
- **实现状态**: ✅ 已完成
- **实现文件**: `valuation_calculator.py`
- **详细说明**:
  - 使用最近季度市净率（pbMRQ）数据
  - 与 PE 计算使用相同的百分位算法
  - 支持 PE/PB 切换显示

### 2. 数据展示功能

#### 2.1 图表展示
- **功能描述**: 使用 Matplotlib 绘制估值走势图
- **实现状态**: ✅ 已完成
- **实现文件**: `chart_view.py`
- **详细说明**:
  - 双 Y 轴设计：左轴显示 PE/PB 值，右轴显示百分位
  - 百分位曲线使用渐变色（低估-绿色、正常-黄色、高估-红色）
  - 显示 30% 和 70% 阈值线
  - 支持中文标签和标题

#### 2.2 鼠标悬停显示
- **功能描述**: 鼠标悬停在图表上时显示详细数据
- **实现状态**: ✅ 已完成
- **实现文件**: `chart_view.py`
- **详细说明**:
  - 显示当前日期
  - 显示收盘价
  - 显示 PE/PB 值
  - 显示百分位数值
  - 垂直参考线指示当前位置

#### 2.3 滑动条控制
- **功能描述**: 通过滑动条选择显示数据的起始位置
- **实现状态**: ✅ 已完成
- **实现文件**: `gui.py`
- **详细说明**:
  - 滑动条范围 0-100
  - 实时更新图表显示
  - 显示当前起始日期

### 3. 数据管理功能

#### 3.1 本地数据缓存
- **功能描述**: 使用 SQLite 存储股票数据，避免重复下载
- **实现状态**: ✅ 已完成
- **实现文件**: `database.py`
- **详细说明**:
  - 自动创建数据库表结构
  - 保存股票历史数据
  - 支持数据更新和替换
  - 数据表字段：日期、代码、开盘价、最高价、最低价、收盘价、PE、PB 等

#### 3.2 股票记忆功能
- **功能描述**: 自动保存查询过的股票，支持快速选择
- **实现状态**: ✅ 已完成
- **实现文件**: `database.py`, `gui.py`
- **详细说明**:
  - 保存股票代码和中文名称
  - 下拉框显示历史记录
  - 格式：`代码 - 名称`（如 `sh.600519 - 贵州茅台`）

#### 3.3 数据刷新
- **功能描述**: 手动刷新股票数据
- **实现状态**: ✅ 已完成
- **实现文件**: `gui.py`, `data_fetcher.py`
- **详细说明**:
  - 强制从 Baostock 重新获取数据
  - 更新本地数据库
  - 显示进度对话框

#### 3.4 数据删除
- **功能描述**: 删除指定股票的本地缓存数据
- **实现状态**: ✅ 已完成
- **实现文件**: `gui.py`, `database.py`
- **详细说明**:
  - 从数据库删除股票数据
  - 从记忆列表移除
  - 清除当前显示

### 4. 用户界面功能

#### 4.1 日期选择
- **功能描述**: 使用日历控件选择日期范围
- **实现状态**: ✅ 已完成
- **实现文件**: `gui.py`
- **详细说明**:
  - 开始日期选择器
  - 结束日期选择器
  - 日期格式：yyyy-mm-dd
  - 修改日期自动重新计算百分位

#### 4.2 时间范围快速选择
- **功能描述**: 快速选择常用时间范围
- **实现状态**: ✅ 已完成
- **实现文件**: `gui.py`
- **详细说明**:
  - 选项：1年、3年、5年、10年、全部
  - 自动调整开始日期
  - 触发数据重新获取

#### 4.3 估值类型切换
- **功能描述**: 在 PE 和 PB 之间切换
- **实现状态**: ✅ 已完成
- **实现文件**: `gui.py`, `valuation_calculator.py`
- **详细说明**:
  - 下拉框选择 PE 或 PB
  - 自动重新计算百分位
  - 更新图表和信息面板

#### 4.4 进度显示
- **功能描述**: 显示数据下载进度
- **实现状态**: ✅ 已完成
- **实现文件**: `gui.py`, `data_fetcher.py`
- **详细说明**:
  - 模态进度对话框
  - 显示当前操作步骤
  - 显示进度百分比
  - 支持关闭对话框

### 5. 系统功能

#### 5.1 中文字体配置
- **功能描述**: 自动配置 Matplotlib 中文字体
- **实现状态**: ✅ 已完成
- **实现文件**: `font_config.py`
- **详细说明**:
  - 自动检测系统字体
  - Windows：Microsoft YaHei、SimHei
  - Linux：WenQuanYi Micro Hei、Noto Sans CJK
  - macOS：Arial Unicode MS、Heiti TC

#### 5.2 依赖检查
- **功能描述**: 启动时检查必要的依赖包
- **实现状态**: ✅ 已完成
- **实现文件**: `main.py`
- **详细说明**:
  - 检查 tkcalendar、matplotlib、pandas、baostock、numpy
  - 提示用户安装缺失的依赖

#### 5.3 错误处理
- **功能描述**: 捕获并显示错误信息
- **实现状态**: ✅ 已完成
- **实现文件**: 所有模块
- **详细说明**:
  - 网络连接错误
  - 数据查询错误
  - 日期格式错误
  - 使用 MessageBox 显示友好提示

## 功能模块关系图

```
┌─────────────────────────────────────────────────────────────┐
│                          GUI 层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   查询控制    │  │   日期选择    │  │   图表展示    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       业务逻辑层                             │
│  ┌──────────────────┐      ┌──────────────────┐            │
│  │   DataFetcher    │      │ ValuationCalculator          │
│  │   (数据获取)      │      │   (估值计算)      │            │
│  └──────────────────┘      └──────────────────┘            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        数据层                                │
│  ┌──────────────────┐      ┌──────────────────┐            │
│  │   StockDatabase  │      │    Baostock API  │            │
│  │   (SQLite 缓存)   │      │   (远程数据源)    │            │
│  └──────────────────┘      └──────────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

## 待优化功能

### 高优先级
- [ ] 优化日期变化时的数据获取逻辑（当前从数据库读取，但可能需要从远程获取更大数据范围）
- [ ] 添加数据导出功能（CSV、Excel）
- [ ] 支持多股票对比

### 中优先级
- [ ] 添加更多估值指标（PS、PCF 等）
- [ ] 支持自定义阈值设置
- [ ] 添加数据更新提醒

### 低优先级
- [ ] 支持主题切换（深色/浅色）
- [ ] 添加图表缩放功能
- [ ] 支持快捷键操作
