# 需求文档

## 文档说明

本文档记录股票估值百分位分析工具的所有需求，包括已实现需求和待实现需求。每次需求更新时，需要同步更新此文档。

**最后更新时间**: 2026-02-03

---

## 一、初始需求（2026-02-03）

### 1.1 核心功能需求

#### R1.1 股票 PE 百分位显示
- **需求描述**: 开发一个 Python 工具，用于显示个股的 PE（市盈率）百分位
- **优先级**: P0（最高）
- **实现状态**: ✅ 已完成
- **详细要求**:
  - 输入股票代码，查询历史 PE 数据
  - 计算 PE 在指定时间范围内的百分位
  - 默认时间范围为 10 年
  - 使用 baostock 作为数据源

#### R1.2 图形化界面
- **需求描述**: 提供友好的 GUI 界面
- **优先级**: P0
- **实现状态**: ✅ 已完成
- **详细要求**:
  - 股票代码输入框
  - 日期范围选择（开始日期、结束日期）
  - 图表展示 PE 走势和百分位
  - 使用 tkinter 开发

#### R1.3 滑动日期选择器
- **需求描述**: 支持通过滑动条选择显示数据的起始日期
- **优先级**: P0
- **实现状态**: ✅ 已完成
- **详细要求**:
  - 滑动条控制显示范围
  - 实时更新图表
  - 显示当前选择的起始日期

#### R1.4 鼠标悬停显示数据
- **需求描述**: 鼠标悬停在图表上时显示详细数据
- **优先级**: P0
- **实现状态**: ✅ 已完成
- **详细要求**:
  - 显示当前日期
  - 显示收盘价
  - 显示 PE 值
  - 显示百分位数值

#### R1.5 本地数据缓存
- **需求描述**: 支持本地数据缓存，避免重复下载
- **优先级**: P0
- **实现状态**: ✅ 已完成
- **详细要求**:
  - 使用 SQLite 存储数据
  - 自动检查本地缓存
  - 数据过期自动更新

#### R1.6 股票代码记忆
- **需求描述**: 自动记忆查询过的股票代码
- **优先级**: P1
- **实现状态**: ✅ 已完成
- **详细要求**:
  - 保存查询历史
  - 下拉框快速选择
  - 显示股票中文名称

---

## 二、迭代需求

### 2.1 第一次迭代（2026-02-03）

#### R2.1 中文显示优化
- **需求描述**: GUI 中不能很好显示中文，需要优化
- **提出时间**: 2026-02-03
- **优先级**: P1
- **实现状态**: ✅ 已完成
- **解决方案**:
  - 创建 `font_config.py` 模块
  - 自动检测系统字体
  - 配置 Matplotlib 中文字体
  - 支持 Windows、Linux、macOS

#### R2.2 鼠标悬停数据实时更新
- **需求描述**: 鼠标悬停时，股票相关数据没有实时更新为鼠标所处位置
- **提出时间**: 2026-02-03
- **优先级**: P1
- **实现状态**: ✅ 已完成
- **解决方案**:
  - 改进悬停检测逻辑
  - 添加垂直参考线
  - 使用 Annotate 显示数据标签
  - 添加鼠标离开事件处理

#### R2.3 数据下载进度显示
- **需求描述**: 下载或更新股票数据时，需要显示进度
- **提出时间**: 2026-02-03
- **优先级**: P1
- **实现状态**: ✅ 已完成
- **解决方案**:
  - 创建 `ProgressDialog` 类
  - 实现进度回调机制
  - 在 `data_fetcher.py` 中添加进度报告
  - 显示当前操作步骤和百分比

#### R2.4 显示股票中文公司名
- **需求描述**: baostock 中有股票的中文公司名，需要将公司名显示在图表上方和历史记忆中
- **提出时间**: 2026-02-03
- **优先级**: P1
- **实现状态**: ✅ 已完成
- **解决方案**:
  - 使用 `query_stock_basic` 接口获取公司名称
  - 在图表标题显示 `代码 - 名称`
  - 在历史记录下拉框显示 `代码 - 名称`
  - 缓存股票名称避免重复查询

#### R2.5 添加 PB 百分位功能
- **需求描述**: 除了 PE 外，增加可选 PB 百分位的功能
- **提出时间**: 2026-02-03
- **优先级**: P1
- **实现状态**: ✅ 已完成
- **解决方案**:
  - 重命名 `pe_calculator.py` 为 `valuation_calculator.py`
  - 支持 PE 和 PB 两种估值类型
  - 在 GUI 中添加估值类型选择下拉框
  - 更新配置文件的估值类型定义

### 2.2 第二次迭代（2026-02-03）

#### R2.6 日期范围百分位计算优化
- **需求描述**: 重新确定开始日期后，PE 百分位需要根据新的日期范围重新计算
- **提出时间**: 2026-02-03
- **优先级**: P1
- **实现状态**: ✅ 已完成
- **解决方案**:
  - 修改 `_on_date_change` 方法
  - 从数据库重新读取指定日期范围的数据
  - 在新的日期范围内重新计算百分位
  - 更新图表和信息显示

---

## 三、需求汇总表

| 需求编号 | 需求名称 | 优先级 | 状态 | 提出时间 |
|---------|---------|--------|------|----------|
| R1.1 | 股票 PE 百分位显示 | P0 | ✅ 已完成 | 初始 |
| R1.2 | 图形化界面 | P0 | ✅ 已完成 | 初始 |
| R1.3 | 滑动日期选择器 | P0 | ✅ 已完成 | 初始 |
| R1.4 | 鼠标悬停显示数据 | P0 | ✅ 已完成 | 初始 |
| R1.5 | 本地数据缓存 | P0 | ✅ 已完成 | 初始 |
| R1.6 | 股票代码记忆 | P1 | ✅ 已完成 | 初始 |
| R2.1 | 中文显示优化 | P1 | ✅ 已完成 | 2026-02-03 |
| R2.2 | 鼠标悬停数据实时更新 | P1 | ✅ 已完成 | 2026-02-03 |
| R2.3 | 数据下载进度显示 | P1 | ✅ 已完成 | 2026-02-03 |
| R2.4 | 显示股票中文公司名 | P1 | ✅ 已完成 | 2026-02-03 |
| R2.5 | 添加 PB 百分位功能 | P1 | ✅ 已完成 | 2026-02-03 |
| R2.6 | 日期范围百分位计算优化 | P1 | ✅ 已完成 | 2026-02-03 |

---

## 四、待实现需求

### 4.1 高优先级需求

#### R3.1 数据导出功能
- **需求描述**: 支持将数据导出为 CSV 或 Excel 格式
- **优先级**: P1
- **状态**: 📝 待实现
- **详细要求**:
  - 导出当前显示的数据
  - 包含日期、收盘价、PE/PB 值、百分位
  - 支持选择导出路径

#### R3.2 多股票对比
- **需求描述**: 支持同时对比多只股票
- **优先级**: P1
- **状态**: 📝 待实现
- **详细要求**:
  - 支持添加多只股票
  - 在同一图表中对比百分位走势
  - 不同颜色区分不同股票

### 4.2 中优先级需求

#### R3.3 更多估值指标
- **需求描述**: 支持 PS（市销率）、PCF（市现率）等指标
- **优先级**: P2
- **状态**: 📝 待实现
- **详细要求**:
  - 在估值类型中添加 PS、PCF 选项
  - 从 baostock 获取对应数据
  - 统一计算百分位

#### R3.4 自定义阈值
- **需求描述**: 允许用户自定义低估/高估阈值
- **优先级**: P2
- **状态**: 📝 待实现
- **详细要求**:
  - 在配置界面中添加阈值设置
  - 支持保存用户设置
  - 默认阈值：30%（低估）、70%（高估）

#### R3.5 数据更新提醒
- **需求描述**: 本地数据过期时提醒用户更新
- **优先级**: P2
- **状态**: 📝 待实现
- **详细要求**:
  - 检测数据最后更新日期
  - 超过一定天数（如 7 天）提醒更新
  - 提供一键更新按钮

### 4.3 低优先级需求

#### R3.6 主题切换
- **需求描述**: 支持深色/浅色主题切换
- **优先级**: P3
- **状态**: 📝 待实现

#### R3.7 图表缩放
- **需求描述**: 支持鼠标滚轮缩放图表
- **优先级**: P3
- **状态**: 📝 待实现

#### R3.8 快捷键支持
- **需求描述**: 支持常用操作的快捷键
- **优先级**: P3
- **状态**: 📝 待实现
- **详细要求**:
  - Ctrl+Q：退出
  - Ctrl+R：刷新
  - Ctrl+F：查询

---

## 五、需求变更记录

### 2026-02-03
- ✅ 完成初始需求（R1.1 - R1.6）
- ✅ 完成第一次迭代需求（R2.1 - R2.5）
- ✅ 完成第二次迭代需求（R2.6）
- 📝 添加待实现需求（R3.1 - R3.8）

---

## 六、附录

### 6.1 术语表

| 术语 | 说明 |
|------|------|
| PE | 市盈率（Price-to-Earnings Ratio），股价/每股收益 |
| PB | 市净率（Price-to-Book Ratio），股价/每股净资产 |
| PS | 市销率（Price-to-Sales Ratio），股价/每股销售额 |
| PCF | 市现率（Price-to-Cash-Flow Ratio），股价/每股现金流 |
| 百分位 | 表示当前值在历史数据中的位置，0%为最低，100%为最高 |
| TTM | 滚动十二个月（Trailing Twelve Months） |
| MRQ | 最近季度（Most Recent Quarter） |

### 6.2 参考资料

- [Baostock 官方文档](http://baostock.com/baostock/index.php)
- [Tkinter 文档](https://docs.python.org/3/library/tkinter.html)
- [Matplotlib 文档](https://matplotlib.org/stable/contents.html)
- [Pandas 文档](https://pandas.pydata.org/docs/)
